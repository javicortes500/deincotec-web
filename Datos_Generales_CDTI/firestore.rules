rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Función helper para identificar administradores
    // Los administradores se loguean con Email/Password o Google (no anónimos)
    function isAdmin() {
      return request.auth != null && 
             !('anonymous' in request.auth.token.firebase.identities) &&
             (request.auth.token.firebase.sign_in_provider == 'password' || 
              request.auth.token.firebase.sign_in_provider == 'google.com');
    }

    match /usuarios/{userId} {
      // LOGIN CLIENTE: Necesita leer su propio documento para verificar si existe y está activo.
      // Al ser el userId la "contraseña", conocer el ID otorga acceso.
      // Se permite GET (leer un documento específico) a cualquiera.
      allow get: if true; 
      
      // ADMIN: Solo el admin puede listar todos los usuarios o modificarlos.
      allow list, write: if isAdmin();
    }
    
    match /clientes/{clientId} {
      // DATOS CLIENTE: Solo el usuario autenticado con ese clientId puede acceder a sus propios datos
      // Esto asegura que un cliente no pueda acceder a datos de otro cliente
      allow get, update: if request.auth != null && request.auth.uid == clientId;
      allow create: if request.auth != null && request.auth.uid == clientId;
      
      // Nunca permitir delete directo de documentos por clientes (solo admin)
      allow delete: if false;
      
      // ADMIN: Puede ver/listar/modificar todos los documentos de clientes
      allow list, read, write, delete: if isAdmin();
    }
  }
}
