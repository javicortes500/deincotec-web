<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario de Recopilación de Datos</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap">
    <link rel="stylesheet" href="style.css">
</head>
<body class="min-h-screen flex flex-col items-center p-4">

    <!-- Pantalla de Login -->
    <div id="login-screen" class="login-container">
        <div class="login-card">
            <img src="logo-deincotec.png" alt="DEINCOTEC Logo" class="login-logo">
            <h1>Formulario de Datos Generales CDTI</h1>
            <p class="login-subtitle">Introduzca la contraseña de acceso proporcionada por su consultor:</p>
            <div id="session-warning" style="display: none; padding: 0.75rem; margin-bottom: 1rem; background-color: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 0.375rem;">
                <p style="margin: 0; font-size: 0.875rem; color: #92400e;">
                    ⚠️ Ya tiene una sesión activa. Si desea usar otra contraseña, <a href="#" onclick="clearSessionAndReload(event)" style="color: #b45309; text-decoration: underline; font-weight: 600;">haga clic aquí</a> para limpiar la sesión.
                </p>
            </div>
            <form id="login-form">
                <div class="input-group">
                    <label for="client-password">Contraseña de Cliente:</label>
                    <input type="password" id="client-password" name="clientPassword" 
                           placeholder="Introduzca su contraseña" required>
                </div>
                <button type="submit" class="btn-primary">Acceder al Formulario</button>
                <div id="login-error" class="error-message" style="display: none;"></div>
            </form>
        </div>
    </div>

    <!-- Aplicación Principal (inicialmente oculta) -->
    <div id="app" class="w-full max-w-6xl" style="display: none;">
        
        <div id="client-view" class="space-y-6">

            <header class="form-header">
                <div class="flex items-center space-x-3">
                    <img src="logo-deincotec.png" alt="DEINCOTEC Logo" class="header-logo">
                    <h1 id="main-title">Recopilación de Datos del Cliente</h1>
                    <div id="client-info" class="client-badge" style="display: none;">
                        Cliente: <span id="client-id"></span>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <button id="show-admin-btn" onclick="promptAdminKey()" disabled style="padding: 0.5rem 1rem; background-color: #d1d5db; color: var(--brand); border-radius: 0.375rem; border: none; font-size: 0.875rem; opacity: 0.5;" title="Inicializando...">Admin</button>
                    <button id="logout-btn" onclick="logout()" style="padding: 0.5rem 1rem; background-color: #ef4444; color: white; border-radius: 0.375rem; border: none; font-size: 0.875rem; display: none;">Cerrar Sesión</button>
                    <div id="autosave-indicator" class="autosave-status">Autosave activo</div>
                </div>
            </header>

            <div class="progress-header">
                <span id="progress-label">Paso 1 de 9</span>
                <span id="progress-percentage">0%</span>
            </div>
            <div class="progress-bar-container">
                <div id="progress-bar-fill" class="progress-bar-fill" style="width: 0%;"></div>
            </div>
            <div class="form-layout-grid">
                
                <div class="stepper-column">
                    <nav id="stepper-nav">
                        <ul>
                            <li id="step-1" class="step active">
                                <span class="step-number">1</span>
                                <span class="step-label">Contactos</span>
                            </li>
                            <li id="step-2" class="step">
                                <span class="step-number">2</span>
                                <span class="step-label">Dirección</span>
                            </li>
                            <li id="step-3" class="step">
                                <span class="step-number">3</span>
                                <span class="step-label">Organización</span>
                            </li>
                            <li id="step-4" class="step">
                                <span class="step-number">4</span>
                                <span class="step-label">Recursos Humanos</span>
                            </li>
                            <li id="step-5" class="step">
                                <span class="step-number">5</span>
                                <span class="step-label">Recursos I+D</span>
                            </li>
                            <li id="step-6" class="step">
                                <span class="step-number">6</span>
                                <span class="step-label">Productos/Servicios</span>
                            </li>
                            <li id="step-7" class="step">
                                <span class="step-number">7</span>
                                <span class="step-label">Tipo Entidad</span>
                            </li>
                            <li id="step-8" class="step">
                                <span class="step-number">8</span>
                                <span class="step-label">Datos Bancarios</span>
                            </li>
                            <li id="step-9" class="step">
                                <span class="step-number">9</span>
                                <span class="step-label">Condiciones</span>
                            </li>
                        </ul>
                    </nav>
                </div>

                <div class="content-column">
                    <form id="data-form" onsubmit="event.preventDefault(); saveFormData(true);">
                        
                        <div data-page="1" class="space-y-6">
                            <div class="page-header">
                                <h3><span class="step-icon">1</span> Página 1 - Contactos</h3>
                                <button type="button" class="info-button" onclick="showInfoPopup('page1')" title="Información sobre esta sección">
                                    <span class="info-button-icon">ℹ</span>
                                    <span>Ayuda</span>
                                </button>
                            </div>
                            <div id="page1-error-message" class="page-error-message hidden"></div>
                            
                            <div class="form-section">
                                <h4 class="font-semibold text-gray-800">Contacto Institucional</h4>
                                <div class="form-grid md:grid-cols-2">
                                    <div>
                                        <label for="instNIF">NIF: <span class="text-red-500">*</span></label>
                                        <input type="text" id="instNIF" oninput="validateField(this, 'nif');" class="input-default" autocomplete="organization">
                                    </div>
                                    <div>
                                        <label for="instNombre">Nombre: <span class="text-red-500">*</span></label>
                                        <input type="text" id="instNombre" oninput="validateField(this, 'required');" class="input-default" autocomplete="name">
                                    </div>
                                    <div>
                                        <label for="instApellidos">Apellidos: <span class="text-red-500">*</span></label>
                                        <input type="text" id="instApellidos" oninput="validateField(this, 'required');" class="input-default" autocomplete="family-name">
                                    </div>
                                    <div>
                                        <label for="instCargo">Cargo: <span class="text-red-500">*</span></label>
                                        <input type="text" id="instCargo" oninput="validateField(this, 'required');" class="input-default">
                                    </div>
                                    <div>
                                        <label for="instTelefono">Teléfono: <span class="text-red-500">*</span></label>
                                        <input type="tel" id="instTelefono" oninput="validatePhoneField(this);" class="input-default" placeholder="9 dígitos" autocomplete="tel" inputmode="numeric" maxlength="9">
                                    </div>
                                    <div>
                                        <label for="instEmail">E-Mail: <span class="text-red-500">*</span></label>
                                        <input type="email" id="instEmail" oninput="validateField(this, 'email');" class="input-default" autocomplete="email">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-section">
                                <h4 class="font-semibold text-gray-800">Contacto Técnico</h4>
                                <div class="form-grid md:grid-cols-3">
                                    <div>
                                        <label for="tecNombre">Nombre: <span class="text-red-500">*</span></label>
                                        <input type="text" id="tecNombre" oninput="validateField(this, 'required');" class="input-default">
                                    </div>
                                    <div>
                                        <label for="tecApellidos">Apellidos: <span class="text-red-500">*</span></label>
                                        <input type="text" id="tecApellidos" oninput="validateField(this, 'required');" class="input-default">
                                    </div>
                                    <div>
                                        <label for="tecCargo">Cargo: <span class="text-red-500">*</span></label>
                                        <input type="text" id="tecCargo" oninput="validateField(this, 'required');" class="input-default">
                                    </div>
                                </div>
                            </div>

                            <div class="form-section">
                                <h4 class="font-semibold text-gray-800">Contacto Financiero</h4>
                                <div class="form-grid md:grid-cols-3">
                                    <div>
                                        <label for="finNombre">Nombre: <span class="text-red-500">*</span></label>
                                        <input type="text" id="finNombre" oninput="validateField(this, 'required');" class="input-default">
                                    </div>
                                    <div>
                                        <label for="finApellidos">Apellidos: <span class="text-red-500">*</span></label>
                                        <input type="text" id="finApellidos" oninput="validateField(this, 'required');" class="input-default">
                                    </div>
                                    <div>
                                        <label for="finCargo">Cargo: <span class="text-red-500">*</span></label>
                                        <input type="text" id="finCargo" oninput="validateField(this, 'required');" class="input-default">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div data-page="2" class="space-y-4 hidden">
                            <div class="page-header">
                                <h3><span class="step-icon">2</span> Página 2 - Dirección</h3>
                                <button type="button" class="info-button" onclick="showInfoPopup('page2')" title="Información sobre esta sección">
                                    <span class="info-button-icon">ℹ</span>
                                    <span>Ayuda</span>
                                </button>
                            </div>
                            <div id="page2-error-message" class="page-error-message hidden"></div>
                            
                            <!-- Dirección de Desarrollo -->
                            <div class="form-section">
                                <h4 class="font-semibold text-gray-800">Dirección de Desarrollo</h4>
                                <div class="form-grid md:grid-cols-3">
                                    <div>
                                        <label for="dirTipoVia">Tipo vía: <span class="text-red-500">*</span></label>
                                        <input type="text" id="dirTipoVia" oninput="validateField(this, 'required');" class="input-default" placeholder="Ej: Calle, Avenida..." autocomplete="street-address">
                                    </div>
                                    <div class="md:col-span-2">
                                        <label for="dirDireccion">Dirección: <span class="text-red-500">*</span></label>
                                        <input type="text" id="dirDireccion" oninput="validateField(this, 'required');" class="input-default">
                                    </div>
                                    <div>
                                        <label for="dirNumero">Número: <span class="text-red-500">*</span></label>
                                        <input type="text" id="dirNumero" oninput="this.value=this.value.replace(/\D/g,''); validateField(this, 'number');" class="input-default" inputmode="numeric">
                                    </div>
                                    <div>
                                        <label for="dirCP">C. Postal: <span class="text-red-500">*</span></label>
                                        <input type="text" id="dirCP" oninput="handleCPInput(this)" class="input-default" placeholder="5 dígitos" inputmode="numeric" maxlength="5" autocomplete="postal-code">
                                    </div>
                                    <div>
                                        <label for="dirProvincia">Provincia: <span class="text-red-500">*</span></label>
                                        <input type="text" id="dirProvincia" readonly>
                                    </div>
                                    <div>
                                        <label for="dirLocalidad">Localidad: <span class="text-red-500">*</span></label>
                                        <input type="text" id="dirLocalidad" readonly>
                                    </div>
                                    <div>
                                        <label for="dirTelefono">Teléfono: <span class="text-red-500">*</span></label>
                                        <input type="tel" id="dirTelefono" oninput="validatePhoneField(this);" class="input-default" placeholder="9 dígitos" autocomplete="tel" inputmode="numeric" maxlength="9">
                                    </div>
                                    <div>
                                        <label for="dirEmail">E-Mail: <span class="text-red-500">*</span></label>
                                        <input type="email" id="dirEmail" oninput="validateField(this, 'email');" class="input-default" autocomplete="email">
                                    </div>
                                </div>
                            </div>

                            <!-- Dirección de Notificaciones -->
                            <div class="form-section">
                                <h4 class="font-semibold text-gray-800">Dirección de Notificaciones</h4>
                                <div class="form-grid md:grid-cols-3">
                                    <div>
                                        <label for="dirNotifTipoVia">Tipo vía: <span class="text-red-500">*</span></label>
                                        <input type="text" id="dirNotifTipoVia" oninput="validateField(this, 'required');" class="input-default" placeholder="Ej: Calle, Avenida..." autocomplete="street-address">
                                    </div>
                                    <div class="md:col-span-2">
                                        <label for="dirNotifDireccion">Dirección: <span class="text-red-500">*</span></label>
                                        <input type="text" id="dirNotifDireccion" oninput="validateField(this, 'required');" class="input-default">
                                    </div>
                                    <div>
                                        <label for="dirNotifNumero">Número: <span class="text-red-500">*</span></label>
                                        <input type="text" id="dirNotifNumero" oninput="this.value=this.value.replace(/\D/g,''); validateField(this, 'number');" class="input-default" inputmode="numeric">
                                    </div>
                                    <div>
                                        <label for="dirNotifCP">C. Postal: <span class="text-red-500">*</span></label>
                                        <input type="text" id="dirNotifCP" oninput="handleCPInputNotif(this)" class="input-default" placeholder="5 dígitos" inputmode="numeric" maxlength="5" autocomplete="postal-code">
                                    </div>
                                    <div>
                                        <label for="dirNotifProvincia">Provincia: <span class="text-red-500">*</span></label>
                                        <input type="text" id="dirNotifProvincia" readonly>
                                    </div>
                                    <div>
                                        <label for="dirNotifLocalidad">Localidad: <span class="text-red-500">*</span></label>
                                        <input type="text" id="dirNotifLocalidad" readonly>
                                    </div>
                                    <div>
                                        <label for="dirNotifTelefono">Teléfono: <span class="text-red-500">*</span></label>
                                        <input type="tel" id="dirNotifTelefono" oninput="validatePhoneField(this);" class="input-default" placeholder="9 dígitos" autocomplete="tel" inputmode="numeric" maxlength="9">
                                    </div>
                                    <div>
                                        <label for="dirNotifEmail">E-Mail: <span class="text-red-500">*</span></label>
                                        <input type="email" id="dirNotifEmail" oninput="validateField(this, 'email');" class="input-default" autocomplete="email">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div data-page="3" class="space-y-4 hidden">
    <div class="page-header">
        <h3><span class="step-icon">3</span> Página 3 - Organización</h3>
        <button type="button" class="info-button" onclick="showInfoPopup('page3')" title="Información sobre esta sección">
            <span class="info-button-icon">ℹ</span>
            <span>Ayuda</span>
        </button>
    </div>
    <div id="page3-error-message" class="page-error-message hidden"></div>

    <!-- Capital Social (se mantiene tal cual) -->
    <div class="form-section">
        <h4 class="font-semibold text-gray-800">Capital Social (Último año)</h4>
        <div class="form-grid md:grid-cols-2">
            <div>
                <label for="orgAnoCapital">Año Capital Social:</label>
                <select id="orgAnoCapital" class="input-default">
                    <option value="">-- Seleccione --</option>
                    <option value="2023">2023</option>
                    <option value="2024">2024</option>
                    <option value="2025">2025</option>
                    <option value="2026">2026</option>
                    <option value="2027">2027</option>
                    <option value="2028">2028</option>
                    <option value="2029">2029</option>
                    <option value="2030">2030</option>
                    <option value="2031">2031</option>
                    <option value="2032">2032</option>
                    <option value="2033">2033</option>
                    <option value="2034">2034</option>
                    <option value="2035">2035</option>
                </select>
            </div>
            <div>
                <label for="orgCapitalSocial">Capital Social (€): <span class="text-red-500">*</span></label>
                <input type="text" id="orgCapitalSocial" oninput="validateCurrencyField(this);" class="input-default" placeholder="Ej: 50.000,00" inputmode="decimal">
            </div>
        </div>
    </div>

    <!-- Composición Accionarial -->
    <div class="form-section">
        <h4 class="font-semibold text-gray-800">Composición Accionarial</h4>
        <div id="accionarial-container">
            <div class="accionarial-grupo form-grid md:grid-cols-2" style="background-color: var(--card); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                <div>
                    <label for="acc_1_nombre">Nombre / Razón Social:</label>
                    <input id="acc_1_nombre" type="text" class="input-default">
                </div>
                <div>
                    <label for="acc_1_cif">CIF:</label>
                    <input id="acc_1_cif" type="text" class="input-default">
                </div>
                <div style="position: relative;">
                    <label for="acc_1_pct">% Participación:</label>
                    <input id="acc_1_pct" type="number" step="0.1" class="input-default" oninput="validatePercentageField(this)">
                </div>
                <div>
                    <label for="acc_1_pyme">Pyme:</label>
                    <select id="acc_1_pyme" class="input-default">
                        <option value="">--</option>
                        <option value="Sí">Sí</option>
                        <option value="No">No</option>
                        <option value="No aplica">No aplica</option>
                    </select>
                </div>
                <div>
                    <label for="acc_1_nacionalidad">Nacionalidad:</label>
                    <input id="acc_1_nacionalidad" type="text" class="input-default">
                </div>
            </div>
        </div>
        <button type="button" onclick="addAccionarialGrupo()" class="mt-4" style="background-color: var(--accent); color: white; padding: 0.6rem 1.2rem; border-radius: 0.5rem; border: none; cursor: pointer; font-weight: 600; transition: background-color 0.2s ease;" onmouseover="this.style.backgroundColor='var(--accent-2)'" onmouseout="this.style.backgroundColor='var(--accent)'">
            <span style="color: white;">+</span> Añadir Accionista
        </button>
    </div>

    <!-- Consejo -->
    <div class="form-section">
        <h4 class="font-semibold text-gray-800">Composición del Consejo de Administración</h4>
        <div id="consejo-container">
            <div class="consejo-grupo form-grid md:grid-cols-2" style="background-color: var(--card); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                <div>
                    <label for="consejo_1_nombre">Nombre:</label>
                    <input id="consejo_1_nombre" type="text" class="input-default">
                </div>
                <div>
                    <label for="consejo_1_dni">DNI/CIF:</label>
                    <input id="consejo_1_dni" type="text" class="input-default">
                </div>
                <div>
                    <label for="consejo_1_cargo">Cargo:</label>
                    <input id="consejo_1_cargo" type="text" class="input-default">
                </div>
                <div>
                    <label for="consejo_1_nacionalidad">Nacionalidad:</label>
                    <input id="consejo_1_nacionalidad" type="text" class="input-default">
                </div>
            </div>
        </div>
        <button type="button" onclick="addConsejoGrupo()" class="mt-4" style="background-color: var(--accent); color: white; padding: 0.6rem 1.2rem; border-radius: 0.5rem; border: none; cursor: pointer; font-weight: 600; transition: background-color 0.2s ease;" onmouseover="this.style.backgroundColor='var(--accent-2)'" onmouseout="this.style.backgroundColor='var(--accent)'">
            <span style="color: white;">+</span> Añadir Miembro
        </button>
    </div>

    <!-- Filiales -->
    <div class="form-section">
        <h4 class="font-semibold text-gray-800">Filiales</h4>
        <div id="filial-container">
            <div class="filial-grupo form-grid md:grid-cols-2" style="background-color: var(--card); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                <div>
                    <label for="filial_1_razon">Razón Social:</label>
                    <input id="filial_1_razon" type="text" class="input-default">
                </div>
                <div>
                    <label for="filial_1_cif">CIF:</label>
                    <input id="filial_1_cif" type="text" class="input-default">
                </div>
                <div>
                    <label for="filial_1_actividad">Actividad Principal:</label>
                    <input id="filial_1_actividad" type="text" class="input-default">
                </div>
                <div>
                    <label for="filial_1_pct">% Participación:</label>
                    <input id="filial_1_pct" type="number" step="0.1" class="input-default">
                </div>
                <div>
                    <label for="filial_1_pais">País:</label>
                    <input id="filial_1_pais" type="text" class="input-default">
                </div>
            </div>
        </div>
        <button type="button" onclick="addFilialGrupo()" class="mt-4" style="background-color: var(--accent); color: white; padding: 0.6rem 1.2rem; border-radius: 0.5rem; border: none; cursor: pointer; font-weight: 600; transition: background-color 0.2s ease;" onmouseover="this.style.backgroundColor='var(--accent-2)'" onmouseout="this.style.backgroundColor='var(--accent)'">
            <span style="color: white;">+</span> Añadir Filial
        </button>
    </div>

</div>

                        <!-- Página 4: Recursos Humanos - será generado dinámicamente por JS -->
                        <div data-page="4" class="space-y-4 hidden">
                            <div class="page-header">
                                <h3><span class="step-icon">4</span> Página 4 - Recursos Humanos</h3>
                                <button type="button" class="info-button" onclick="showInfoPopup('page4')" title="Información sobre esta sección">
                                    <span class="info-button-icon">ℹ</span>
                                    <span>Ayuda</span>
                                </button>
                            </div>
                            <div id="page4-error-message" class="page-error-message hidden"></div>
                            <div id="recursos-container" class="space-y-4"></div>
                        </div>

                        <div data-page="5" class="space-y-4 hidden">
                            <div class="page-header">
                                <h3><span class="step-icon">5</span> Página 5 - Recursos I+D</h3>
                                <button type="button" class="info-button" onclick="showInfoPopup('page5')" title="Información sobre esta sección">
                                    <span class="info-button-icon">ℹ</span>
                                    <span>Ayuda</span>
                                </button>
                            </div>
                            <p class="text-sm text-gray-500">Indique los recursos destinados a I+D (histórico y previstos).</p>
                            
                            <div id="recursos-id-container" class="overflow-x-auto">
                                <!-- La tabla se generará dinámicamente aquí -->
                            </div>
                        </div>

                        <div data-page="6" class="space-y-4 hidden">
                            <div class="page-header">
                                <h3><span class="step-icon">6</span> Página 6 - Productos/Servicios</h3>
                                <button type="button" class="info-button" onclick="showInfoPopup('page6')" title="Información sobre esta sección">
                                    <span class="info-button-icon">ℹ</span>
                                    <span>Ayuda</span>
                                </button>
                            </div>
                            <div id="page6-error-message" class="page-error-message hidden"></div>
                            
                            <div id="productos-container" class="space-y-4">
                                <!-- Los productos se renderizan dinámicamente aquí -->
                            </div>
                            
                            <button type="button" onclick="addProductoGrupo()" class="btn-add" style="background-color: var(--accent); color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 600; cursor: pointer; border: none;">
                                + Añadir Producto/Servicio
                            </button>
                        </div>
                        
                        <div data-page="7" class="space-y-4 hidden">
                            <div class="page-header">
                                <h3><span class="step-icon">7</span> Página 7 - Tipo de Entidad</h3>
                                <button type="button" class="info-button" onclick="showInfoPopup('page7')" title="Información sobre esta sección">
                                    <span class="info-button-icon">ℹ</span>
                                    <span>Ayuda</span>
                                </button>
                            </div>
                            <div id="page7-error-message" class="page-error-message hidden"></div>
                            
                            <div class="form-grid md:grid-cols-2">
                                <div>
                                    <label for="entidadTipo">Tipo de Entidad:</label>
                                    <select id="entidadTipo" class="input-default">
                                        <option value="">-- Seleccione --</option>
                                        <option value="Autonoma">Empresa Autónoma</option>
                                        <option value="Asociada">Empresa Asociada</option>
                                        <option value="Vinculada">Empresa Vinculada</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="entidadTamaño">Tamaño Entidad:</label>
                                    <select id="entidadTamaño" class="input-default">
                                        <option value="">-- Seleccione --</option>
                                        <option value="Pequeña">Pequeña Empresa</option>
                                        <option value="Mediana">Mediana Empresa</option>
                                        <option value="Grande">Gran Empresa</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="entidadPeriodoRef">Periodo de Referencia:</label>
                                    <select id="entidadPeriodoRef" class="input-default" onchange="actualizarEjercicioAnterior()">
                                        <option value="">-- Seleccione --</option>
                                        <option value="2024">2024</option>
                                        <option value="2025">2025</option>
                                        <option value="2026">2026</option>
                                        <option value="2027">2027</option>
                                        <option value="2028">2028</option>
                                        <option value="2029">2029</option>
                                        <option value="2030">2030</option>
                                        <option value="2031">2031</option>
                                        <option value="2032">2032</option>
                                        <option value="2033">2033</option>
                                        <option value="2034">2034</option>
                                        <option value="2035">2035</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-section" style="margin-top: 2rem;">
                                <h4 class="font-semibold text-gray-800">Datos último ejercicio cerrado</h4>
                                <div class="form-grid md:grid-cols-3">
                                    <div>
                                        <label for="ent_efectivos">Efectivos (UTA):</label>
                                        <input type="text" id="ent_efectivos" class="input-default" oninput="validateIntegerField(this)">
                                    </div>
                                    <div>
                                        <label for="ent_volumen_negocio">Volumen de Negocio (€):</label>
                                        <input type="text" id="ent_volumen_negocio" class="input-default" oninput="validateCurrencyField(this)" placeholder="Ej: 1.500.000,00">
                                    </div>
                                    <div>
                                        <label for="ent_balance_general">Balance General (€):</label>
                                        <input type="text" id="ent_balance_general" class="input-default" oninput="validateCurrencyField(this)" placeholder="Ej: 2.000.000,00">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-section">
                                <h4 class="font-semibold text-gray-800" id="ejercicioAnteriorTitle">Ejercicio anterior</h4>
                                <div class="form-grid md:grid-cols-3">
                                    <div>
                                        <label for="ent_anterior_efectivos">Efectivos (UTA):</label>
                                        <input type="text" id="ent_anterior_efectivos" class="input-default" oninput="validateIntegerField(this)">
                                    </div>
                                    <div>
                                        <label for="ent_anterior_volumen_negocio">Volumen de Negocio (€):</label>
                                        <input type="text" id="ent_anterior_volumen_negocio" class="input-default" oninput="validateCurrencyField(this)" placeholder="Ej: 1.500.000,00">
                                    </div>
                                    <div>
                                        <label for="ent_anterior_balance_general">Balance General (€):</label>
                                        <input type="text" id="ent_anterior_balance_general" class="input-default" oninput="validateCurrencyField(this)" placeholder="Ej: 2.000.000,00">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div data-page="8" class="space-y-4 hidden">
                            <div class="page-header">
                                <h3><span class="step-icon">8</span> Página 8 - Datos Bancarios</h3>
                                <button type="button" class="info-button" onclick="showInfoPopup('page8')" title="Información sobre esta sección">
                                    <span class="info-button-icon">ℹ</span>
                                    <span>Ayuda</span>
                                </button>
                            </div>
                            <div class="form-grid md:grid-cols-3">
                                <div class="md:col-span-3">
                                    <label for="bankIBAN">IBAN:</label>
                                    <input type="text" id="bankIBAN" class="input-default" placeholder="ES00" maxlength="4" oninput="validateBankField(this, 'iban')">
                                </div>
                                <div>
                                    <label for="bankEntidad">Entidad:</label>
                                    <input type="text" id="bankEntidad" class="input-default" placeholder="1234" maxlength="4" oninput="validateBankField(this, 'entidad')">
                                </div>
                                <div>
                                    <label for="bankOficina">Oficina:</label>
                                    <input type="text" id="bankOficina" class="input-default" placeholder="5678" maxlength="4" oninput="validateBankField(this, 'oficina')">
                                </div>
                                <div>
                                    <label for="bankDC">DC:</label>
                                    <input type="text" id="bankDC" class="input-default" placeholder="90" maxlength="2" oninput="validateBankField(this, 'dc')">
                                </div>
                                <div class="md:col-span-3">
                                    <label for="bankNumero">Número de Cuenta:</label>
                                    <input type="text" id="bankNumero" class="input-default" placeholder="0123456789" maxlength="10" oninput="validateBankField(this, 'cuenta')">
                                </div>
                            </div>
                        </div>

                        <div data-page="9" class="space-y-4 hidden">
                            <div class="page-header">
                                <h3><span class="step-icon">9</span> Página 9 - Condiciones</h3>
                                <button type="button" class="info-button" onclick="showInfoPopup('page9')" title="Información sobre esta sección">
                                    <span class="info-button-icon">ℹ</span>
                                    <span>Ayuda</span>
                                </button>
                            </div>
                            <p class="text-sm text-gray-500">Por favor, lea y acepte las siguientes condiciones.</p>
                            
                            <div class="form-section">
                                <h4 class="font-semibold text-gray-800">Condiciones Presentación Empresa</h4>
                                <div class="space-y-6">
                                    <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem;">
                                        <label for="cond_1" class="block text-sm text-gray-700" style="text-align: justify; flex: 1; cursor: pointer;">
                                            <strong>1. Estoy informado/a de las condiciones FEDER:</strong> He leído las características de este tipo de ayudas y las obligaciones inherentes a la financiación FEDER. Estas modalidades de proyectos se apoyan con Ayudas Parcialmente Reembolsables cofinanciadas por Fondo Europeo de Desarrollo Regional (FEDER). Si su proyecto recibe finalmente cofinanciación FEDER, deberá aceptar, como beneficiario, determinadas obligaciones. Si desea acceder a la solicitud electrónica ha de leer y darse por informado de las características y obligaciones inherentes a la financiación FEDER.
                                        </label>
                                        <input id="cond_1" type="checkbox" class="h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500" style="min-width: 1.25rem; margin-top: 0.125rem; flex-shrink: 0;">
                                    </div>
                                    
                                    <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem;">
                                        <label for="cond_2" class="block text-sm text-gray-700" style="text-align: justify; flex: 1; cursor: pointer;">
                                            <strong>2. Tratamiento de datos de carácter personal:</strong><br><br>
                                            Los datos de carácter personal asociados al expediente serán tratados por el CDTI con la finalidad de llevar a cabo la tramitación del expediente así como el control de la ayuda concedida, en su caso. Tales datos personales tienen carácter necesario y su no presentación determinará la imposibilidad de continuar con el procedimiento.<br><br>
                                            CDTI está legitimado para el tratamiento de los datos en virtud de la Ley 14/2011, de 1 de junio, de la Ciencia, la Tecnología y la Innovación, que lo designa como agente de financiación del Sistema Español de Ciencia, Tecnología e Innovación.<br><br>
                                            Los datos serán protegidos y conservados conforme a lo dispuesto en el Reglamento (UE) 2016/679 del Parlamento Europeo y del Consejo, de 27 de abril de 2016, y resto de normativa aplicable durante los plazos establecidos en la normativa reguladora de la ayuda.<br><br>
                                            El CDTI realizará cesiones de datos a las Administraciones Públicas, a las entidades y sujetos que estipule la Ley. Asimismo, las entidades que colaboren con CDTI en la evaluación del presente proyecto podrán tener acceso a tales datos personales con la única y exclusiva finalidad de realizar la referida evaluación.<br><br>
                                            En el proceso de evaluación del proyecto, el CDTI podrá solicitar la colaboración de otras entidades. Acepto que se envíe la documentación de la propuesta a estas entidades para la realización del informe de valoración.<br><br>
                                            El titular de los datos podrá ejercer los derechos de acceso, rectificación y supresión, de limitación del tratamiento y de oposición a través de los medios indicados en la página web del CDTI ("aviso legal"). Igualmente tendrán derecho a presentar reclamación ante la Agencia Española de Protección de Datos.
                                        </label>
                                        <input id="cond_2" type="checkbox" class="h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500" style="min-width: 1.25rem; margin-top: 0.125rem; flex-shrink: 0;">
                                    </div>
                                    
                                    <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem;">
                                        <label for="cond_3" class="block text-sm text-gray-700" style="text-align: justify; flex: 1; cursor: pointer;">
                                            <strong>3. Estoy informado/a de las condiciones que aplican al porcentaje máximo de gastos generales:</strong><br><br>
                                            El importe de gastos generales que se considerará elegible a efectos de solicitar la cofinanciación europea de la ayuda, será el resultante de la aplicación de un porcentaje del 15% sobre los gastos directos de personal del proyecto válidamente justificados, en virtud de lo previsto en el Reglamento (UE) 651/2014, de 17 de junio.
                                        </label>
                                        <input id="cond_3" type="checkbox" class="h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500" style="min-width: 1.25rem; margin-top: 0.125rem; flex-shrink: 0;">
                                    </div>
                                    
                                    <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem;">
                                        <label for="cond_4" class="block text-sm text-gray-700" style="text-align: justify; flex: 1; cursor: pointer;">
                                            <strong>4. Estoy informado/a de las condiciones de cofinanciación:</strong><br><br>
                                            En los proyectos cofinanciados con fondos FEDER, solo se financiarán aquellas actividades del proyecto que sean desarrolladas en el ámbito geográfico de la Comunidad Autónoma que figure como "Comunidad de Desarrollo". En este sentido, la partida de «Gastos de Personal» corresponderá a personas que realicen sus trabajos en dicha comunidad, de forma tal que el trabajador debe estar dado de alta en un centro de trabajo de la Comunidad Autónoma correspondiente.
                                        </label>
                                        <input id="cond_4" type="checkbox" class="h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500" style="min-width: 1.25rem; margin-top: 0.125rem; flex-shrink: 0;">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-section">
                                <h4 class="font-semibold text-gray-800">Condiciones Presentación Proyecto</h4>
                                <div class="space-y-6">
                                    <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem;">
                                        <label for="cond_5" class="block text-sm text-gray-700" style="text-align: justify; flex: 1; cursor: pointer;">
                                            <strong>1. Confidencialidad y transparencia:</strong><br><br>
                                            En el supuesto de la existencia de información confidencial por razón de su vinculación a secretos técnicos o comerciales u otros motivos debidamente justificados, el solicitante deberá designarla expresamente como tal en los documentos correspondientes, sin que sea admisible una declaración genérica de confidencialidad.<br><br>
                                            No obstante, de conformidad con la normativa vigente en materia de publicidad y transparencia de ayudas públicas, los datos del proyecto y de los beneficiarios así como el importe de la ayuda concedida, en su caso, serán públicos. Esta información también podrá utilizarse con fines estadísticos y de análisis, seguimiento y mejora de las ayudas de I+D+i, y/o por exigencias legales.
                                        </label>
                                        <input id="cond_5" type="checkbox" class="h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500" style="min-width: 1.25rem; margin-top: 0.125rem; flex-shrink: 0;">
                                    </div>
                                    
                                    <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem;">
                                        <label for="cond_6" class="block text-sm text-gray-700" style="text-align: justify; flex: 1; cursor: pointer;">
                                            <strong>2. Estoy informado de que para dar cumplimiento al Reglamento (UE) 2021/1060 del Parlamento Europeo y del Consejo de 24 de junio de 2021,</strong> se requiere un informe favorable, único por proyecto y emitido por entidad acreditada por la ENAC según el esquema RDE-31, que confirme el cumplimiento del principio de «no causar un perjuicio significativo» ó DNSH por sus siglas en inglés. El informe se presentará por la empresa al CDTI entre la aprobación del proyecto y la firma del contrato. El informe deberá responder a los objetivos del art. 9 y a los aspectos recogidos en el art. 17 del Reglamento (UE) 2020/852 del Parlamento Europeo y del Consejo de 18 de junio de 2020 y sus actos delegados.
                                        </label>
                                        <input id="cond_6" type="checkbox" class="h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500" style="min-width: 1.25rem; margin-top: 0.125rem; flex-shrink: 0;">
                                    </div>
                                    
                                    <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem;">
                                        <label for="cond_7" class="block text-sm text-gray-700" style="text-align: justify; flex: 1; cursor: pointer;">
                                            <strong>3. Materias excluidas:</strong><br><br>
                                            Estoy informado de las materias excluidas de la cofinanciación FEDER recogidas en el Artículo 7 del REGLAMENTO (UE) 2021/1058 DEL PARLAMENTO EUROPEO Y DEL CONSEJO de 24 de junio de 2021.
                                        </label>
                                        <input id="cond_7" type="checkbox" class="h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500" style="min-width: 1.25rem; margin-top: 0.125rem; flex-shrink: 0;">
                                    </div>
                                    
                                    <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem;">
                                        <label for="cond_8" class="block text-sm text-gray-700" style="text-align: justify; flex: 1; cursor: pointer;">
                                            <strong>4. Declaro que:</strong><br><br>
                                            A) Toda la información que figura en esta solicitud es veraz.<br><br>
                                            B) Me comprometo a informar de todas las modificaciones sustanciales previas a la aprobación del proyecto. Si cualquiera de las anteriores condiciones se viese incumplida, se podría suspender la evaluación del proyecto.
                                        </label>
                                        <input id="cond_8" type="checkbox" class="h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500" style="min-width: 1.25rem; margin-top: 0.125rem; flex-shrink: 0;">
                                    </div>
                                    
                                    <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem;">
                                        <label for="cond_9" class="block text-sm text-gray-700" style="text-align: justify; flex: 1; cursor: pointer;">
                                            <strong>5. Estoy informado/a de las condiciones de la CCAA:</strong><br><br>
                                            En el proceso de evaluación de la propuesta, el CDTI podrá pedir un informe de valoración al organismo competente de la Comunidad Autónoma en donde se vaya a realizar el proyecto. Acepto que se envíe la documentación de la propuesta a dicho organismo para la realización de dicho informe de valoración.
                                        </label>
                                        <input id="cond_9" type="checkbox" class="h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500" style="min-width: 1.25rem; margin-top: 0.125rem; flex-shrink: 0;">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="form-message" class="hidden h-4"></div>

                        <div id="form-navigation">
                            <button type="button" id="prev-btn" onclick="navigatePage(-1)">
                                Atrás
                            </button>
                            <span id="page-indicator" class="hidden"></span>
                            <button type="button" id="next-btn" onclick="navigatePage(1)">
                                Siguiente
                            </button>
                            <button type="submit" id="save-btn" class="hidden">
                                Guardar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div id="admin-view" class="hidden space-y-6">
            <div class="flex justify-between items-center border-b pb-2">
                <h2 class="text-2xl font-bold text-blue-800">Panel de Administración</h2>
                <button onclick="logout()" style="padding: 0.5rem 1rem; background-color: #ef4444; color: white; border-radius: 0.375rem; border: none; font-size: 0.875rem; cursor: pointer; font-weight: 600;">
                    Cerrar Sesión
                </button>
            </div>

            <!-- Gestión de Usuarios -->
            <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                <h3 class="text-xl font-bold text-blue-800 mb-4">Gestión de Usuarios</h3>
                
                <!-- Formulario para crear nuevo usuario -->
                <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                    <h4 class="font-semibold text-blue-900 mb-3">Crear Nuevo Usuario</h4>
                    <div class="flex gap-3 items-end">
                        <div class="flex-1">
                            <label class="block text-sm font-medium text-gray-700 mb-1">ID Cliente / Nombre</label>
                            <input type="text" id="new-user-id" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="ej: empresa-abc">
                        </div>
                        <div class="flex-1">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Contraseña</label>
                            <input type="text" id="new-user-password" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Contraseña para el cliente">
                        </div>
                        <button onclick="createNewUser()" class="bg-green-600 text-white font-semibold px-6 py-2 rounded-md hover:bg-green-700 transition-colors duration-200">
                            Crear Usuario
                        </button>
                    </div>
                    <p class="text-xs text-gray-600 mt-2">El ID será único para cada cliente. La contraseña se enviará al cliente para que pueda acceder.</p>
                </div>

                <!-- Lista de usuarios existentes -->
                <div>
                    <h4 class="font-semibold text-gray-900 mb-3">Usuarios Existentes</h4>
                    <div class="overflow-x-auto rounded-lg border border-gray-200">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">ID Cliente</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Contraseña</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Estado</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Creado</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="users-table-body" class="bg-white divide-y divide-gray-100">
                                <tr><td colspan="5" class="text-center py-4 text-gray-500">Cargando usuarios...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Datos Recopilados -->
            <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                <h3 class="text-xl font-bold text-blue-800 mb-4">Datos Recopilados (Tiempo Real)</h3>

            <div class="flex justify-between items-center mb-4">
                <p class="text-sm text-gray-500">
                    <span class="font-semibold text-gray-700">ID de la Aplicación (Compartir):</span>
                    <span id="app-id-display" class="bg-gray-200 text-gray-800 px-2 py-1 rounded-md text-xs select-all"></span>
                </p>
                <button onclick="exportToCSV()" class="bg-green-600 text-white font-semibold px-4 py-2 rounded-lg shadow hover:bg-green-700 transition-colors duration-200 flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    Exportar a CSV (Excel)
                </button>
            </div>

            <div class="overflow-x-auto rounded-lg border border-gray-200">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-blue-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-blue-700 uppercase tracking-wider">Últ. Guardado</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-blue-700 uppercase tracking-wider">ID Cliente</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-blue-700 uppercase tracking-wider">Nombre (Inst.)</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-blue-700 uppercase tracking-wider">Email (Inst.)</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-blue-700 uppercase tracking-wider">Teléfono (Inst.)</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-blue-700 uppercase tracking-wider">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="data-table-body" class="bg-white divide-y divide-gray-100">
                        <tr><td colspan="6" class="text-center py-4 text-gray-500">Cargando datos...</td></tr>
                    </tbody>
                </table>
            </div>
            <p id="data-loading-status" class="text-center text-sm text-gray-500"></p>
            </div>
        </div>
    </div>

    <div id="message-modal" class="fixed inset-0 modal-overlay hidden items-center justify-center p-4 z-50">
        <div class="modal-box">
            <h3 id="modal-title" class="modal-title"></h3>
            <p id="modal-content" class="modal-content"></p>
            <input type="password" id="modal-input" class="hidden modal-input mb-4" placeholder="Clave de Administrador">
            <div class="modal-actions">
                <button id="modal-cancel-btn" class="hidden" style="background-color: #6b7280;">Cancelar</button>
                <button id="modal-confirm-btn" class="">Aceptar</button>
            </div>
        </div>
    </div>
    
    <footer class="site-footer">
      <span>© DEINCOTEC · Consultoría I+D+i</span>
    </footer>

    <!-- Pop-up de Información -->
    <div id="info-popup-overlay" class="info-popup-overlay">
        <div class="info-popup">
            <div class="info-popup-header">
                <h4>
                    <span class="info-icon">ℹ</span>
                    <span id="info-popup-title">Información</span>
                </h4>
                <button class="info-popup-close" onclick="closeInfoPopup()">×</button>
            </div>
            <div id="info-popup-content" class="info-popup-content">
                <!-- El contenido se insertará dinámicamente -->
            </div>
        </div>
    </div>

    <!-- SheetJS library for Excel export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script type="module" src="main.js"></script>
</body>
</html>