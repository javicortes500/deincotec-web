<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cuestionario · DEINCOTEC</title>
  <meta name="description" content="Formulario multipaso con guardado automático" />
  <style>
    :root { --bg:#fff; --card:#f8f9fa; --text:#212529; --muted:#6c757d; --accent:#0d6efd; --border:#dee2e6; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif;background:var(--bg);color:var(--text)}
    .container{max-width:900px;margin:0 auto;padding:24px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:24px}
    h1{margin:0 0 12px 0}
    .muted{color:var(--muted);font-size:14px}
    .actions{display:flex;gap:12px;justify-content:space-between;margin-top:24px}
    .btn{border:1px solid var(--border);background:#fff;padding:10px 14px;border-radius:10px;cursor:pointer}
    .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
    .stepper{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:16px}
    .chip{padding:6px 10px;border-radius:999px;border:1px solid var(--border)}
    .chip.active{background:var(--accent);color:#fff;border-color:var(--accent)}
    form{display:grid;gap:16px}
    label{font-weight:600}
    input,select,textarea{width:100%;padding:10px;border:1px solid var(--border);border-radius:8px}
    small.autosave{color:var(--muted)}
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>Cuestionario</h1>
      <p class="muted">Guardado automático activado</p>
      <div id="stepper" class="stepper"></div>
      <form id="form"></form>
      <div class="actions">
        <button id="prev" class="btn" type="button">← Anterior</button>
        <div style="display:flex;gap:8px">
          <small id="autosaveHint" class="autosave"> </small>
          <button id="next" class="btn primary" type="button">Continuar →</button>
        </div>
      </div>
    </div>
  </div>

<script>
const GAS_BASE_URL = 'https://script.google.com/macros/s/AKfycbwJ7ZgufOGMpOThKCgSGalSQd__5iU_oNUK6h-OwY-icH4Na0TyCd1cBHqi8FULQacw/exec';

const SCHEMA = [
  {
    "name": "I+D",
    "title": "I+D",
    "fields": [
      {
        "key": "I",
        "label": "I",
        "type": "text"
      }
    ]
  }
];

// ======= Estado =======
let pageIndex = 0;
let sessionId = null;
let formData = {};
let saveTimer = null;

function qs(id){return document.getElementById(id)}

function renderStepper(){
  const el = qs('stepper'); el.innerHTML = '';
  SCHEMA.forEach((p, i) => {
    const chip = document.createElement('div');
    chip.className = 'chip' + (i===pageIndex?' active':'');
    chip.textContent = `${i+1}. ${p.title}`;
    chip.onclick = ()=>{ pageIndex = i; renderPage(); };
    el.appendChild(chip);
  });
}

function renderPage(){
  renderStepper();
  const page = SCHEMA[pageIndex];
  const el = qs('form'); el.innerHTML='';
  (page.fields||[]).forEach(f=>{
    const wrap = document.createElement('div');
    const lbl = document.createElement('label'); lbl.textContent = f.label; lbl.htmlFor = f.key;
    let input;
    if (f.type === 'textarea') {
      input = document.createElement('textarea'); input.rows = 4;
    } else if (f.type === 'select') {
      input = document.createElement('select');
    } else {
      input = document.createElement('input'); input.type = f.type || 'text';
    }
    input.id = f.key; input.name = f.key; if (f.required) input.required = true;
    input.value = (formData[page.name]?.[f.key]) || '';
    input.addEventListener('input', onInputChangeDebounced);
    wrap.appendChild(lbl); wrap.appendChild(input);
    el.appendChild(wrap);
  });
}

function onInputChangeDebounced(e){
  const page = SCHEMA[pageIndex];
  const key = e.target.name; const value = e.target.value;
  formData[page.name] = formData[page.name] || {};
  formData[page.name][key] = value;
  debounceSave();
}

function debounceSave(){
  qs('autosaveHint').textContent = 'Guardando…';
  if (saveTimer) clearTimeout(saveTimer);
  saveTimer = setTimeout(()=>savePage(), 600);
}

async function savePage(){
  const page = SCHEMA[pageIndex];
  const payload = { sessionId, pageName: page.name, data: formData[page.name] || {} };
  try {
    const res = await fetch(`${GAS_BASE_URL}?path=save`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    if (!res.ok) throw new Error('Network response was not ok');
    const json = await res.json();
    if (!json.ok) throw new Error(json.error || 'Error en save');
    qs('autosaveHint').textContent = 'Cambios guardados automáticamente';
  } catch (err) {
    console.error(err);
    qs('autosaveHint').textContent = 'Error al guardar. Reintentando…';
  }
}

async function init(){
  try {
    const url = new URL(location.href);
    const token = url.searchParams.get('t');
    const res = await fetch(`${GAS_BASE_URL}?path=init`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ sessionId: token })
    });
    if (!res.ok) throw new Error('Network response was not ok');
    const json = await res.json();
    if (!json.ok) { alert('Error iniciando sesión'); return; }
    sessionId = json.sessionId;
    console.log('Reanudar:', location.origin + location.pathname + `?t=${sessionId}`);
  } catch (err) {
    console.error('Init error', err);
    alert('Error iniciando sesión');
    return;
  }
  renderPage();
}

qs('prev').onclick = async ()=>{
  if (pageIndex > 0) { await savePage(); pageIndex--; renderPage(); }
}
qs('next').onclick = async ()=>{
  if (pageIndex < SCHEMA.length-1) { await savePage(); pageIndex++; renderPage(); }
  else {
    const res = await fetch(`${GAS_BASE_URL}?path=finalize`, { method:'POST', body: JSON.stringify({ sessionId }) });
    const json = await res.json();
    if (json.ok) alert('Formulario completado. ¡Gracias!');
  }
}

init();
</script>
</body>
</html>
